#!/usr/bin/expect -f
# Spawns claude, runs /usage, waits for output, then exits cleanly.
# Uses pattern matching instead of fixed sleeps for reliability.

log_file -noappend /tmp/claude-usage-log.txt
log_user 1
set timeout 25

spawn claude

# Wait for the welcome screen to fully render — look for the context % indicator
expect {
    -re {\[[0-9]+%\]} {}
    timeout { exit 1 }
}

# Small pause for UI to stabilize after welcome screen
sleep 0.3

# Type /usage and tab-complete
send "/usage"
sleep 0.3
send "\t"

# Wait for the autocomplete to resolve
expect {
    -re {/usage} {}
    timeout {}
}
sleep 0.2

# Submit the command
send "\r"

# Wait for the actual usage data to appear — look for "% used" which appears
# in every usage section. We need all three sections, so wait for "Sonnet"
# which is the last one.
expect {
    -re {Sonnet} {
        # Give a moment for the final percentage to render
        sleep 0.5
    }
    timeout {
        # Even on timeout, the partial output may be usable
        sleep 0.5
    }
}

# Exit: press Escape to dismiss the panel, then /exit to quit
send "\033"
sleep 0.3
send "/exit"
sleep 0.2
send "\t"
sleep 0.2
send "\r"

expect {
    eof {}
    timeout { close }
}
